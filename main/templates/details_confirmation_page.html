{% extends 'base.html' %}
{% load static %}
{% block content %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Passenger Details</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f0f0f0;
            padding: 20px;
        }


        .passenger-name {
            font-weight: bold;
        }

        li{
            list-style: none;
        }

        .header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        }

        .company-name {
            background: #FF7300;
            padding: 20px;
            border-radius: 20px;
            width: 130%;
            display: flex;
            position: relative;
            bottom: 64px;
            font-size: 20px;
            font-weight: bold;
            margin-left: -49px;
        }

        .departure-time {
            position: relative;
            bottom: 145px;
            margin-left: 225px;
            width: fit-content;
            height: fit-content;
            display: flex;
            font-weight: bold;
        }

        .seconds {
            position: relative;
            bottom: 170px;
            margin-left: 228px;
            margin-top: 20px;
            width: fit-content;
            display: flex;
            height: fit-content;
            font-weight: bold;
        }

        .passenger-details-container {
            background: white;
            padding: inherit;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
            position: relative;
            margin-top: 30px;
            border-radius: 20px;
        }

        .price-container {
            background: white;
            padding: 50px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
            position: relative;
            border-radius: 20px;
        }

        .passenger-details-container::after {
            content: "";
            display: block;
            position: absolute;
            bottom: 0;
            left: 14px;
            width: 91%;
            border-bottom: 1px dashed black;
        }

        #tripResults {
            position: relative;
            display: flex;
            flex-direction: column;
            width: fit-content;
            margin-left: -5px;
            /* bottom: 165px; */
        }

        .origin-destination {
            position: relative;
            z-index: 1;
            top: 73px;
            right: 8px;
            width: 53%;
            display: flex;
            gap: 60px;
        }

        .origin-destination  i{
            font-size: 20px;
        }

        .trip-details{
            height: 0;
        }

        .plate-number-text{
            display: flex;
            flex-direction: column;
            height: 0;
            width: 40%;
            position: relative;
            right: 20px;
            bottom: 20px;
            font-size: 14px;
        }

        .plate-number{
            position: relative;
            top: 13px;
            right: 19px;
        }

        .departure-date-text {
            display: flex;
            width: 0;
            height: 0;
            position: relative;
            left: 226px;
            bottom: 43px;
            font-size: 14px;
        }

        .departure-date{
            position: relative;
            top: 12px;
            left: 68px;
            font-weight: bold;
        }

        #passengerDetails {
            position: relative;
            display: flex;
            top: 15px;
            flex-direction: column;
            margin-left: 4px;
            width: fit-content;
        }

        .seat-number {
            position: relative;
            left: 235px;
            bottom: 35px;
            font-size: 14px;
            background: #6248FF;
            padding: 7px;
            border-radius: 13px;
            color: white;
            width: fit-content;
            display: flex;
        }

        .total-price {
            display: flex;
            height: 0;
            width: 95px;
            position: relative;
            bottom: 30px;
            left: 65px;
        }

        .price {
            font-weight: bold;
            position: relative;
            top: 180px;
            z-index: 1;
            margin-top: 57px;
            left: 20px;
        }

        #tripSubmitionButton {
            width: 86%;
            position: relative;
            left: 25px;
            border-radius: 8px;
            border: 1px solid;
            margin-top: 30px;
            height: 32px;
            background: #FF7300;
            color: white;
            font-weight: bold;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            cursor: pointer;
        }

       
    </style>
</head>
<body>
    <div class="error-message" id="error-message"></div>
    <ul id="tripResults"></ul>

    <div id="tripDetails">
        <!-- Trip details will be dynamically generated here -->
    </div>

    <div id="passengerDetails"></div>

    <button id="submitButton" style="display: none;">Submit</button> 
    
    <!-- Modal -->
    <div id="phoneNumberModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <form id="modalForm">
                <label>Select Payment Method:</label><br>
                <select id="paymentMethod">
                    <option value="mtn-money">MTN Money</option>
                    <option value="airtel-money">Airtel Money</option>
                </select><br><br>
                <label for="paymentPhoneNumber">Enter Payment Phone Number:</label><br>
                <input type="text" id="paymentPhoneNumber" name="paymentPhoneNumber" required><br><br>
                <button type="submit" id="modalSubmitButton">Submit</button>
            </form>
        </div>
    </div>


    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script>
        $(document).ready(function() {

            const access_token= localStorage.getItem('access_token')
           
            // Initializing the buyer user Id
            var buyer_user_id;

            $.ajax({
                url: 'https://yenda-app-api.onrender.com/api/v1/user_id',
                type: 'GET',
                contentType: "application/json",
                beforeSend: function(xhr) {
                    xhr.setRequestHeader("Authorization", "Bearer " + access_token);
                },
                success: function(response) {
                    console.log('User ID:', response.data.user_id);
                    buyer_user_id = response.data.user_id
                    $('#submitButton').show();

                },
                error: function(xhr, status, error) {
                    console.error('Error:', error);
                }
            });

           


            // Retrieve selected seats from localStorage
            const selectedSeats = JSON.parse(localStorage.getItem('selectedSeats'));

            if (!selectedSeats || selectedSeats.length === 0) {
                // No selected seats found
                $('#passengerDetails').html('<p>No seats selected.</p>');
            } else {
                // Display form data
                const passengerDetailsDiv = $('#passengerDetails');

                // Initialize empty arrays for passenger details
                var passengerNames = [];
                var passengerPhoneNumbers = [];
                var passengerEmails = [];
                var seatNumbers = [];
                var formDataKeysToRemove = []; // Declare a global array to store formDataKeys

                selectedSeats.forEach(function(seat) {
                    const formDataKey = 'passengerDetails_' + seat;
                    formDataKeysToRemove.push(formDataKey); // Store formDataKey in the global array
                    const formData = JSON.parse(localStorage.getItem(formDataKey));
                    if (formData) {
                        const parsedFormData = decodeURIComponent(formData.replace(/\+/g, ' ')); // Decode form data
                        const name = parsedFormData.match(/name=([^&]*)/)[1]; // Extract name from form data
                        const email = parsedFormData.match(/email=([^&]*)/)[1]; // Extract email from form data
                        const phone = parsedFormData.match(/phone=([^&]*)/)[1]; // Extract phone from form data

                        passengerDetailsDiv.append('<p class="passenger-info"><span class="seat-number">Seat ' + seat + ':</span> <span class="passenger-name">' + name + '</span></p>');
                        passengerNames.push(name);
                        passengerPhoneNumbers.push(phone);
                        passengerEmails.push(email);
                        seatNumbers.push(seat);
                    } else {
                        passengerDetailsDiv.append('<p class="passenger-info">No details found for Seat ' + seat + '.</p>');
                    }
                });
            }


        
        // Retrieve trip data
        var tripsData = JSON.parse(localStorage.getItem('tripResults'));
        var trip; 
        var totalPrice = 0; 
        var operator_phone_number

        // Check if tripsData contains the 'data' key
        if ('data' in tripsData && Array.isArray(tripsData.data)) {
            var tripResultsList = $("#tripResults");
            tripsData.data.forEach(function(tripData) {
                trip = tripData; // Assign trip data to the trip variable
                var listItem = $("<li></li>");
                var link = $("<a></a>")
                    .text(trip.attributes.origin + " to " + trip.attributes.destination);
                var details = $("<p></p>")
                    .text("Company: " + trip.attributes.user.company_name + ", Price: " + trip.attributes.price + ", Date: " + trip.attributes.departure_date + ", Time: " + trip.attributes.departure_time + ", Plate Number: " + trip.attributes.bus.number_plate);

                var featuresList = $("<ul></ul>");
                trip.attributes.bus.features.forEach(function(feature) {
                    featuresList.append($("<li></li>").text(feature.name));
                });


                var operator_phone_number = trip.attributes.user.phone_number;
            
                // Calculate total price
                var seatPrice = trip.attributes.price;
                totalPrice = seatPrice * (selectedSeats ? selectedSeats.length : 0);

                // Add total price to the details
                details.append("<br><strong>Total Price for " + (selectedSeats ? selectedSeats.length : 0) + " seats: " + totalPrice + "</strong>");

                listItem.append(link);
                listItem.append(details);
                listItem.append(featuresList);
                tripResultsList.append(listItem);
            });
        } else {
            // Handle case where tripsData does not have 'data' key or it is not an array
            console.error("The 'data' key is missing or not an array in tripsData:", tripsData);
        }

        $('.close').click(function() {
            $('#phoneNumberModal').hide();
        });

        $(window).click(function(event) {
            if (event.target.className === 'modal') {
                $('#phoneNumberModal').hide();
            }
        });

        // JavaScript in your HTML page
        $('#submitButton').click(function(e) {
                e.preventDefault();
                $('#phoneNumberModal').show();
        });

        $('#modalForm').submit(function(e) {
            e.preventDefault();

            $('#modalSubmitButton').val('Submitting...');

            var paymentPhoneNumber = $('#paymentPhoneNumber').val();
            var paymentMethod = $('#paymentMethod').val(); 

            var seatPrice = trip.attributes.price;
            var totalPrice = seatPrice * (selectedSeats ? selectedSeats.length : 0);

            var formData = {
                "trip":trip.id,
                "bus":trip.attributes.bus.id,
                "buyer_user_id": buyer_user_id,
                "passenger_name": passengerNames,
                "passenger_phonenumber": passengerPhoneNumbers,
                "passenger_email": passengerEmails,
                "seat_number": seatNumbers,
                "total_price": totalPrice,
                "payment_phone_number": paymentPhoneNumber,
                "operator_phone_number": '0966142238',
                "payment_method": paymentMethod,
            };

            var formDataString = JSON.stringify(formData);
            console.log("Data:", formDataString);

            $.ajax({
                url: 'https://yenda-crs-api-2.onrender.com/api/v1/trip-submission/',
                type: 'POST',
                contentType: 'application/json',
                data: formDataString,
                success: function(response) {
                    $('#modalSubmitButton').val('Submit');

                    console.log('Form submitted successfully:', response);

                    localStorage.removeItem('tripResults');
                    localStorage.removeItem('selectedSeats');
                    formDataKeysToRemove.forEach(function(formDataKey) {
                        localStorage.removeItem(formDataKey);
                    });
                    localStorage.setItem('ticketResults', JSON.stringify(response));

                    $('#phoneNumberModal').hide();

                    window.location.href = '{% url "ticket-success" %}';
                },
                error: function(xhr, status, error) {
                    $('#modalSubmitButton').val('Submit');

                    console.error('Error submitting form:', error);
                    var errorMessage = xhr.responseJSON.errors.error; // Extract the specific error message
                    displayErrorMessage(errorMessage); // Display the extracted error message; 
                }
            });
        });

        
        function displayErrorMessage(error) {
            var errorMessageDiv = $('#error-message');
            errorMessageDiv.text(error);
            errorMessageDiv.show();

            setTimeout(function() {
                errorMessageDiv.hide();
            }, 5000);
        }
});
    </script>
    </body>
    </html>
{% endblock %}